
<!DOCTYPE HTML>
<meta http-equiv="Content-Type" content="text/html;charset=utf-8">
<title>WSPR reception at SIARS, Chennai, India</title>

<script src="http://maps.google.com/maps/api/js?v=3&amp;sensor=false&libraries=geometry" type="text/javascript"></script>

</head>
<style>
body {background-color: black; color: white; font-family: sans;}
a:link {color: yellow; }
a:visited {color: #AAAA00; }
</style>

<!--<script type="text/javascript" src="resources/label.js"></script>-->

<script type="text/javascript">
// from http://webcache.googleusercontent.com/search?q=cache:hmxjv8XYGlkJ:http://blog.mridey.com/2011/05/label-overlay-example-for-google-maps.html%2Blabel+overlay+example+for+google+maps+ridey&hl=nl&output=search&sclient=psy-ab&gbv=1&ct=clnk
// with modified style

// Define the overlay, derived from google.maps.OverlayView
function Label(opt_options) {
  // Initialization
  this.setValues(opt_options);


  // Label specific
  var span = this.span_ = document.createElement('span');
//  span.style.cssText = 'position: relative; left: -50%; top: -8px; ' + 'white-space: nowrap; border: 1px solid blue; ' + 'padding: 2px; background-color: white';
  span.style.cssText = 'position: relative; left: -50%; top: -10px; ' + 'white-space: nowrap; border: 1px solid black; ' + 'padding: 0px; background-color: white; font-size: 10px; font-family:sans-serif;';


  var div = this.div_ = document.createElement('div');
  div.appendChild(span);
  div.style.cssText = 'position: absolute; display: none';
};
Label.prototype = new google.maps.OverlayView;


// Implement onAdd
Label.prototype.onAdd = function() {
  var pane = this.getPanes().overlayImage;
  pane.appendChild(this.div_);


  // Ensures the label is redrawn if the text or position is changed.
  var me = this;
  this.listeners_ = [
    google.maps.event.addListener(this, 'position_changed', function() { me.draw(); }),
    google.maps.event.addListener(this, 'visible_changed', function() { me.draw(); }),
    google.maps.event.addListener(this, 'clickable_changed', function() { me.draw(); }),
    google.maps.event.addListener(this, 'text_changed', function() { me.draw(); }),
    google.maps.event.addListener(this, 'zindex_changed', function() { me.draw(); }),
    google.maps.event.addDomListener(this.div_, 'click', function() {
      if (me.get('clickable')) {
        google.maps.event.trigger(me, 'click');
      }
    })
  ];
};


// Implement onRemove
Label.prototype.onRemove = function() {
  this.div_.parentNode.removeChild(this.div_);


  // Label is removed from the map, stop updating its position/text.
  for (var i = 0, I = this.listeners_.length; i < I; ++i) {
    google.maps.event.removeListener(this.listeners_[i]);
  }
};


// Implement draw
Label.prototype.draw = function() {
  var projection = this.getProjection();
  var position = projection.fromLatLngToDivPixel(this.get('position'));

  this.span_.style.cssText = 'position: relative; left: -50%; top: -10px; white-space: nowrap; font-size: 10px; font-family:sans-serif;' + this.mystyle;

  var div = this.div_;
  div.style.left = position.x + 'px';
  div.style.top = position.y + 'px';


  var visible = this.get('visible');
  div.style.display = visible ? 'block' : 'none';


  var clickable = this.get('clickable');
  this.span_.style.cursor = clickable ? 'pointer' : '';


  var zIndex = this.get('zIndex');
  div.style.zIndex = zIndex;


  this.span_.innerHTML = this.get('text').toString();
};
</script>

<body onload="bodyonload()">

<p>

<h2>WSPR reception at SIARS, Chennai</h2>
<p>
WSPR signals are 2-minute long beacons transmitted by many amateurs around the world.
The map below shows WSPR spots received at SIARS, the websdr in chennai, India
<p>
<div id="controls"></div>
<br>
<span style="font-weight: bold; font-size: 130%;" id="date"></span>
&nbsp;
<span id="bands"></span>
<p>
<div id="map_canvas" style="height: 800px; color:black"></div>
<p>
<span id="bands"></span>
<br>
<pre><div id="debug"></div></pre> 


<script type="text/javascript">

/////////////////////////////////////////////////////////
//This prototype is provided by the Mozilla foundation and
//is distributed under the MIT license.
//http://www.ibiblio.org/pub/Linux/LICENSES/mit.license
if (!Array.prototype.forEach)
{
  Array.prototype.forEach = function(fun /*, thisp*/)
  {
    var len = this.length;
    if (typeof fun != "function") throw new TypeError();
    var thisp = arguments[1];
    for (var i = 0; i < len; i++) if (i in this) fun.call(thisp, this[i], i, this);
  };
}
/////////////////////////////////////////////////////////

/**
* Date.parse with progressive enhancement for ISO 8601 <https://github.com/csnover/js-iso8601>
* © 2011 Colin Snover <http://zetafleet.com>
* Released under MIT license.
*/
(function (Date, undefined) {
    var origParse = Date.parse, numericKeys = [ 1, 4, 5, 6, 7, 10, 11 ];
    Date.parse = function (date) {
        var timestamp, struct, minutesOffset = 0;

        // ES5 §15.9.4.2 states that the string should attempt to be parsed as a Date Time String Format string
        // before falling back to any implementation-specific date parsing, so that’s what we do, even if native
        // implementations could be faster
        // 1 YYYY 2 MM 3 DD 4 HH 5 mm 6 ss 7 msec 8 Z 9 ± 10 tzHH 11 tzmm
        if ((struct = /^(\d{4}|[+\-]\d{6})(?:-(\d{2})(?:-(\d{2}))?)?(?:T(\d{2}):(\d{2})(?::(\d{2})(?:\.(\d{3}))?)?(?:(Z)|([+\-])(\d{2})(?::(\d{2}))?)?)?$/.exec(date))) {
            // avoid NaN timestamps caused by “undefined” values being passed to Date.UTC
            for (var i = 0, k; (k = numericKeys[i]); ++i) {
                struct[k] = +struct[k] || 0;
            }

            // allow undefined days and months
            struct[2] = (+struct[2] || 1) - 1;
            struct[3] = +struct[3] || 1;

            if (struct[8] !== 'Z' && struct[9] !== undefined) {
                minutesOffset = struct[10] * 60 + struct[11];

                if (struct[9] === '+') {
                    minutesOffset = 0 - minutesOffset;
                }
            }

            timestamp = Date.UTC(struct[1], struct[2], struct[3], struct[4], struct[5] + minutesOffset, struct[6], struct[7]);
        }
        else {
            timestamp = origParse ? origParse(date) : NaN;
        }

        return timestamp;
    };
}(Date));

/////////////////////////////////////////////////////////

// rest of the Javascript code copyright 2012-2013, P.T. de Boer, PA3FWM, pa3fwm@amsat.org

var nomap=false;



var map;
var mapoverlays=[];

var sites=[];
sites["pa3fwm"]=new google.maps.LatLng(52.23456,6.8514);

var bandcolors=
[
   '#cf0000',  // LF
   '#ff0000',  // MF
   '#ff7f00',   // 160m
   '#808080',
//   '#ffd400',   // 80m
   '#e0c000',   // 80m
   '#808080',
   '#b0b000',   // 60m
   '#808080',
   '#60cc00',   // 40m
   '#808080',
   '#808080',
//   '#00e572',   // 30m
   '#00a0a0',   // 30m
   '#808080',
   '#808080',
   '#808080',
//   '#00cccc',   // 20m
   '#008fff',   // 20m
   '#808080',
   '#808080',
   '#808080',
   '#003fff',   // 17m
   '#808080',
   '#808080',
//   '#6000ff',   // 15m
   '#8020ff',   // 15m
   '#808080',
   '#808080',
   '#af00ff',   // 12m
   '#808080',
   '#808080',
   '#808080',
   '#ff00ff',   // 10m
   '#ff00ff'    // 10m
];

var bandcolors_rgb=[];

var bandnames=
[
   'LF',
   'MF',
   '160m',
   '',
   '80m',
   '',
   '60m',
   '',
   '40m',
   '',
   '',
   '30m',
   '',
   '',
   '',
   '20m',
   '',
   '',
   '',
   '17m',
   '',
   '',
   '15m',
   '',
   '',
   '12m',
   '',
   '',
   '',
   '10m',
   '',
];




function bodyonload()
{
  try {
     infowindow = new google.maps.InfoWindow( { content: "-" } );
  } catch(e) {
     nomap=true;
  }
  if (nomap) { document.getElementById("map_canvas").innerHTML="Google maps seems to be disabled?!"; return; }

  var opt= {
    zoom:2,
    center: new google.maps.LatLng(25,80),
    mapTypeId: google.maps.MapTypeId.ROADMAP,
  };
  map = new google.maps.Map(document.getElementById("map_canvas"), opt);

  map.setOptions({draggableCursor:'crosshair'});
  document.getElementById("debug").innerHTML="";

  for (var i=0;i<bandcolors.length;i++) {
     c=bandcolors[i];
     var cc={};
     cc.r=parseInt(c.substr(1,2),16);
     cc.g=parseInt(c.substr(3,2),16);
     cc.b=parseInt(c.substr(5,2),16);
     bandcolors_rgb.push(cc);
  }

  realnow=new Date().getTime()/1000;

  now=realnow;
  now=Math.floor(now/120)*120;

  fetchdata('pi4tht');
}


function fetchdata(call)
{
  var xmlHttp;
  try { xmlHttp=new XMLHttpRequest(); }
    catch (e) { try { xmlHttp=new ActiveXObject("Msxml2.XMLHTTP"); }
      catch (e) { try { xmlHttp=new ActiveXObject("Microsoft.XMLHTTP"); }
        catch (e) { alert("Your browser does not support AJAX!"); return false; } } }
  xmlHttp.onreadystatechange=function()
    {
    if(xmlHttp.readyState==4)
      {
        readspots(xmlHttp.responseText);
      }
    }
  var url="wspr-now.txt?"+(new Date().getTime()/1000);
  if (xmlHttp.overrideMimeType) xmlHttp.overrideMimeType("text/plain");
  xmlHttp.open("GET",url,true);
  xmlHttp.send(null);
}


function findsite(s)
{
   if (sites[s]) return sites[s];
   else {
      // try to interpret it as a QTH locator
      var q=s.toUpperCase();
      if (q.length<6) q=q+"LL";
      var lon=-180+1/24. + (q.charCodeAt(0)-65)*20 + (q.charCodeAt(2)-48)*2 + (q.charCodeAt(4)-65)*1./12;
      var lat=-90 +1/48. + (q.charCodeAt(1)-65)*10 + (q.charCodeAt(3)-48)*1 + (q.charCodeAt(5)-65)*1./24;
      return new google.maps.LatLng(lat,lon);
   }
}

var heard=[];
var spotsperband=[];
var things=[];
var timewindow=3600;

var bandchoice=-1;
var hidedots=true;
var hidelabel=false;




function doshow()
{
  mysite=findsite('jo32kf');

  // show date&time
  var d=new Date(now*1000);
  function pad(n){return n<10 ? '0'+n : n};
  document.getElementById("date").innerHTML=d.getUTCFullYear()+'-'+pad(1+d.getUTCMonth())+'-'+pad(d.getUTCDate())+' '+pad(d.getUTCHours())+':'+pad(d.getUTCMinutes())+"z";

  var image=new google.maps.MarkerImage('circle1b.png', new google.maps.Size(9,9), new google.maps.Point(0,0), new google.maps.Point(4,4));
  var images=[
     new google.maps.MarkerImage('circle1b.png', new google.maps.Size(9,9), new google.maps.Point(0,0), new google.maps.Point(4,4)),
     new google.maps.MarkerImage('circle_9_90.png', new google.maps.Size(9,9), new google.maps.Point(0,0), new google.maps.Point(4,4)),
     new google.maps.MarkerImage('circle_9_80.png', new google.maps.Size(9,9), new google.maps.Point(0,0), new google.maps.Point(4,4)),
     new google.maps.MarkerImage('circle_9_70.png', new google.maps.Size(9,9), new google.maps.Point(0,0), new google.maps.Point(4,4)),
     new google.maps.MarkerImage('circle_9_60.png', new google.maps.Size(9,9), new google.maps.Point(0,0), new google.maps.Point(4,4)),
     new google.maps.MarkerImage('circle_9_50.png', new google.maps.Size(9,9), new google.maps.Point(0,0), new google.maps.Point(4,4)),
     new google.maps.MarkerImage('circle_9_40.png', new google.maps.Size(9,9), new google.maps.Point(0,0), new google.maps.Point(4,4)),
     new google.maps.MarkerImage('circle_9_30.png', new google.maps.Size(9,9), new google.maps.Point(0,0), new google.maps.Point(4,4)),
     new google.maps.MarkerImage('circle_9_20.png', new google.maps.Size(9,9), new google.maps.Point(0,0), new google.maps.Point(4,4)),
     new google.maps.MarkerImage('circle_9_10.png', new google.maps.Size(9,9), new google.maps.Point(0,0), new google.maps.Point(4,4)),
  ];

  // remove old overlays
  things.forEach(function (i) {
     i.setMap(null);
  });
  things=[];

  // shade the night area
  var ciop={
     radius: 10000000,
     fillOpacity: 0.1,
     center: new google.maps.LatLng(-23.5*Math.sin((now/(365.2425*86400)-0.22)*2*3.14159265),-5*(now%86400)*360/86400),  // not exact, but good enough for now...
     map: map,
     clickable: false,
     strokeColor: 'grey',
     strokeWeight: 0
  };
  var ci=new google.maps.Circle(ciop); 
  things.push(ci);


  if (heard.length==0) return;


  function doshow_collect(i) {
     var j=-1;
     if (calls.indexOf) j=calls.indexOf(i.callpair);
     var spot={freq:i.freq, snr:i.snr, time:i.time2, rev:i.rev};
     var bandok=(bandchoice<0 || i.band==bandchoice);
     if (j<0) {
        // new call: add to arrays
        calls.push(i.callpair);
        spotbs.push([i.band+100*i.rev]);
        spots.push([spot]);
        return bandok ? calls.length-1 : -1;
     } else {
        // old call: update spots list
        if (spotbs[j].indexOf(i.band+100*i.rev)<0) {
           spotbs[j].push(i.band+100*i.rev);
           spots[j].push(spot);
           return bandok ? j : -1;
        }
        return -1;
     }
  }

  function doshow_one(i) {
    if (!i.loc) return;  // but how can this happen?
    var pc=[findsite(i.rxloc),findsite(i.loc)];
    var ti=now-i.time;
    var o=1-ti/timewindow;
    var c=bandcolors[i.band];
    var cc=bandcolors_rgb[i.band];

    // prepare the infowindow contents
    var rev=(i.rxcall<i.call);
    var s;
    s=i.call+' -> '+i.rxcall+' ('+i.dist+' km)<br><table>';
    spots[i.u].sort( function(a,b){return a.freq - b.freq} );
    spots[i.u].forEach(function (j) {
       s+='<tr><td>'+((j.rev==rev)?'->':'<-')+'</td><td>'+(j.freq*1000).toFixed(3)+' kHz</td><td>'+j.snr+' dB</td><td>'+j.time+'</td></tr>';
    });
    s+='</table>';

    // draw the path
    var p=new google.maps.Polyline({
      path:pc,
      geodesic:true,
      strokeColor: c,
      strokeOpacity: o,
      strokeWeight: 2
      });
    p.setMap(map);
    attach_infowindow_line(p, infowindow, s);
    things.push(p);

    // draw marker
    if (!hidedots) {
       var q=new google.maps.Marker({
          position: findsite(i.loc),
          map: map,
          icon: images[Math.floor((1-o)*10)],
          });
       things.push(q);
       attach_infowindow(q, infowindow, s);
    }
    // draw label
    var label;
    if (!hidelabel) {
       label = new Label({map:map});
       label.set('position',findsite(i.loc));
       label.set('visible',true);
       label.set('clickable',true);
       label.set('zIndex',0);
       label.set('text',i.call);
       label.set('mystyle', 'border: 0px solid black; padding: 0px; color: rgba(0,0,0,'+o+'); background-color: rgba('+cc.r+','+cc.g+','+cc.b+','+o+');');
       things.push(label);
       attach_infowindow(label, infowindow, s);
    }
  }

  var i;
  i=100;
  // quickly (i.e., big steps) search for an entry which is old enough to be shown (binary search could be even faster...)
  while (i<heard.length) {
     if (heard[i].time<now) break;
     i+=100;
  }
  if (i>=heard.length) i=heard.length;
  // step back to exactly the first (i.e. most recent) entry old enough to be shown
  while (i>0 && heard[i-1].time<=now) i--;
  if (i>=heard.length) return;
  if (i<0) return;
  // now walk through the list forward (i.e., towards older entries), collecting data as we go:
  calls=[];    // list of (unique) call pairs we see
  spots=[];    // for that call pair, array of spots, per band the most recent one
  spotbs=[];   // for that call pair, list of bands on which we've seen it (this is redundant information since it's also in spots[], but makes searching easier to implement
  uniques=[];  // indices in heard[] of latest entry of each unique call pair (on band of interest, if bandchoice>=0)
  var mintime=now-timewindow;
  while (i<heard.length && heard[i].time>mintime) {
     var z=doshow_collect(heard[i]);
     if (z>=0) {
        heard[i].u=z;
        uniques.push(i);
     }
     i++;
  }
  // finally, go over that list of unique calls from oldest to newest to show them (in this order to hopefully make newer lines appear on top)
  for (i=uniques.length-1; i>=0; i--) doshow_one(heard[uniques[i]]);
}




function attach_infowindow(q, infowindow, s)
{
      google.maps.event.addListener(q, 'click', function() { 
         infowindow.setContent(s);
         infowindow.open(map,q); 
      } );
}

function attach_infowindow_line(line, infowindow, s)
{
   google.maps.event.addListener(line, 'click', function(event) { 
      infowindow.setContent(s);
      infowindow.setPosition(event.latLng);
      infowindow.open(map); 
   } );
}




function readspots(a)
{
   var lines=a.split('\n');
   heard=[];
   while (lines.length) {
//      var b = lines.shift().match(/row.*\/tr>/);
      var b = lines.shift();
      if (!b) continue;
      b=""+b;
      var data = b.split("&nbsp;");
      var ti= Date.parse((data[1]+'Z').replace(' ','T'));
      ti/=1000;
//     document.getElementById("debug").innerHTML+=data[11]+' '+data[1]+' '+ti+' '+data[5]+'<br>';
      var freq=data[5];
      var call=data[3];
      var rxcall=data[17];
      var snr=data[7];
      var dist=data[21];
//      var b=(freq|0);
      var b=(freq|0)+1;
      if (freq<0.4) b=0;
      var rev=0;
      var callpair=call+'_'+rxcall;
      if (call>rxcall) { callpair=rxcall+'_'+call; rev=1; }
      heard.push({ 
         loc:data[11], 
         time:ti, 
         time2:data[1].substr(11,5), 
         call:call, 
         dist:dist, 
         band:b, 
         freq:freq, 
         rxloc:data[19],
         rxcall:rxcall,
         callpair:callpair,
         rev:rev,
         snr:snr });
   }

   heard.sort( function(a,b){return b.time - a.time} );

   var s="";
   s='<form name="selform" action="#">';
   s+='<input style="background-color: #AAAAAA" type="button" value="ALL" onclick="bandchoice=-1; doshow();">';
   for (var i=0;i<30;i++)
      if (bandnames[i]!='')
         s+='<input style="background-color: '+bandcolors[i]+'" type="button" value="'+bandnames[i]+'" onclick="bandchoice='+i+'; doshow();">';
   s+='<br>';
   s+='<input style="background-color: #AAAAAA" type="button" value="lines" onclick="hidedots=true; hidelabel=true; doshow();">';
   s+='<input style="background-color: #AAAAAA" type="button" value="dots" onclick="hidedots=false; hidelabel=true; doshow();">';
   s+='<input style="background-color: #AAAAAA" type="button" value="labels" onclick="hidedots=true; hidelabel=false; doshow();">';
   s+='<input style="background-color: #AAAAAA" type="button" value="1h" onclick="timewindow=3600; doshow();">';
   s+='<input style="background-color: #AAAAAA" type="button" value="6h" onclick="timewindow=21600; doshow();">';
   s+='<input style="background-color: #AAAAAA" type="button" value="24h" onclick="timewindow=86400; doshow();">';
   s+='<input style="background-color: #AAAAAA" type="button" value="refresh" onclick="fetchdata(\'\');">';
   s+='</form>';
   document.getElementById("controls").innerHTML=s;

   realnow=heard[0].time;
   now=realnow;
   oldest=heard[heard.length-1].time;
   doshow(-1, now);
}



function setband(b)
{
   doshow(b, now);
}



</script>


</body>
</html>

